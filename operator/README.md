# Keboola MCP Server Operator

This directory contains instructions for scaffolding a Kubernetes operator to manage the deployment of the Keboola MCP Server using the Helm chart located in `../charts/keboola-mcp-server`.

## Prerequisites

- [Operator SDK](https://sdk.operatorframework.io/docs/installation/)
- [Go programming language](https://go.dev/doc/install)
- Access to a Kubernetes cluster (e.g., minikube, kind, Docker Desktop)
- `kubectl` configured to interact with your cluster
- `make`
- A container registry (like Docker Hub, ghcr.io, Quay.io) where the operator image will be pushed.

## Scaffolding the Operator

Follow these steps to generate the Helm-based operator project structure.

1.  **Navigate to the Operator Directory:**

    ```bash
    # Make sure you are in the 'operator' directory of the keboola-mcp-server repository
    cd /path/to/keboola-mcp-server/operator
    ```

2.  **Initialize the Operator Project:**

    Replace `yourdomain.com` with your actual domain.

    ```bash
    operator-sdk init --domain=yourdomain.com --repo=github.com/keboola/keboola-mcp-server/operator --plugins=helm
    ```

    *   `--domain`: Used for the API group of the Custom Resource Definition (CRD).
    *   `--repo`: Go module path for the operator project.
    *   `--plugins=helm`: Specifies that this is a Helm-based operator.

3.  **Create the API for the MCPServer Kind:**

    This command tells the Operator SDK to create a new API (CRD and controller) based on the existing Helm chart.

    ```bash
    operator-sdk create api --group=mcp --version=v1alpha1 --kind=MCPServer --helm-chart=../charts/keboola-mcp-server
    ```

    *   `--group`, `--version`, `--kind`: Define the GroupVersionKind (GVK) for your Custom Resource (`MCPServer`).
    *   `--helm-chart`: Points to the Helm chart directory we created earlier.

    This will:
    *   Create the `MCPServer` Custom Resource Definition (CRD) in `config/crd/bases/mcp.yourdomain.com_mcpservers.yaml`.
    *   Generate Go types for the `MCPServer` resource in `api/v1alpha1/mcpserver_types.go` based on the `values.yaml` from the Helm chart.
    *   Set up the operator's `watches.yaml` file to monitor `MCPServer` resources and reconcile them using the specified Helm chart.
    *   Create a sample `MCPServer` Custom Resource (CR) in `config/samples/mcp_v1alpha1_mcpserver.yaml`.

4.  **Review Generated Files:**

    *   Examine `api/v1alpha1/mcpserver_types.go`. Ensure the `MCPServerSpec` struct fields correctly reflect the options in `../charts/keboola-mcp-server/values.yaml`. Pay close attention to sections like `keboola`, `image`, `service`, `mcpTransport`, and how secrets are handled.
    *   Review the sample CR `config/samples/mcp_v1alpha1_mcpserver.yaml`. Customize it with appropriate values for a test deployment. Note that you will likely need to provide values for `keboola.apiUrl`, `keboola.workspaceSchema`, and configure secrets (`keboola.storageTokenSecretName` or `existingSecret`) for the operator to deploy a functional MCP Server instance.
    *   Check the generated `Dockerfile` and `Makefile`.

## Building and Deploying (Example)

**Note:** The actual deployment will be handled by a separate process/repository as per the requirements.
These are example commands generated by the SDK for local testing or CI/CD integration.

1.  **Build and Push the Operator Image:**
    Replace `<your-registry>/keboola-mcp-operator:<tag>` with your container registry and desired tag.

    ```bash
    make docker-build docker-push IMG=<your-registry>/keboola-mcp-operator:<tag>
    ```

2.  **Deploy the Operator to the Cluster:**

    ```bash
    make deploy IMG=<your-registry>/keboola-mcp-operator:<tag>
    ```
    This installs the CRD and deploys the operator controller manager.

3.  **Deploy an Instance of MCPServer:**

    Apply the sample CR (or your customized version).

    ```bash
    kubectl apply -f config/samples/mcp_v1alpha1_mcpserver.yaml
    ```

The operator will detect the new `MCPServer` resource and deploy the application using the Helm chart.

## Next Steps

*   Customize the generated Go types (`api/v1alpha1/mcpserver_types.go`) if needed (e.g., add validation annotations).
*   Refine the sample CR (`config/samples/mcp_v1alpha1_mcpserver.yaml`) with realistic default values.
*   Integrate the build and deployment steps into the CI/CD pipeline of the deployment repository. 